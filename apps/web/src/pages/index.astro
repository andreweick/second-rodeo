---
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import Header from '../components/Header.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

// Call your API Worker
const apiBase = import.meta.env.PUBLIC_API_BASE ?? "http://127.0.0.1:8787";

let apiOk = false;
try {
  const r = await fetch(`${apiBase}/health`, { headers: { accept: "application/json" } });
  const j = await r.json();
  apiOk = Boolean(j?.ok);
} catch {}

// Fetch a sample D1 row
let doc: { id: string; title: string; updated_at: number } | null = null;
try {
  const r = await fetch(`${apiBase}/d1/docs/doc_1`, { headers: { accept: "application/json" } });
  if (r.ok) doc = await r.json();
} catch {}
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={SITE_TITLE} description={SITE_DESCRIPTION} />
  </head>
  <body>
    <Header />
    <main>
      <h1>üßë‚ÄçüöÄ Hello, Astronaut!</h1>
      <p>
        Welcome to the official <a href="https://astro.build/">Astro</a> blog starter template. This
        template serves as a lightweight, minimally-styled starting point for anyone looking to build
        a personal website, blog, or portfolio with Astro.
      </p>

      <!-- New: API status + D1 doc -->
      <section style="margin: 2rem 0; padding: 1rem; border: 1px solid #eee; border-radius: .5rem;">
        <h2>Backend Status</h2>
        <p>API health: {apiOk ? "ok" : "unreachable"}</p>

        <h3>Doc from D1</h3>
        {doc
          ? <p><strong>{doc.title}</strong> <small>(id: {doc.id})</small></p>
          : <p>No doc yet. Try running in another terminal: <code>curl http://127.0.0.1:8787/d1/init</code></p>}
      </section>

      <p>
        This template comes with a few integrations already configured in your
        <code>astro.config.mjs</code> file. You can customize your setup with
        <a href="https://astro.build/integrations">Astro Integrations</a> to add tools like Tailwind,
        React, or Vue to your project.
      </p>
      <p>Here are a few ideas on how to get started with the template:</p>
      <ul>
        <li>Edit this page in <code>src/pages/index.astro</code></li>
        <li>Edit the site header items in <code>src/components/Header.astro</code></li>
        <li>Add your name to the footer in <code>src/components/Footer.astro</code></li>
        <li>Check out the included blog posts in <code>src/content/blog/</code></li>
        <li>Customize the blog post page layout in <code>src/layouts/BlogPost.astro</code></li>
      </ul>
      <p>
        Have fun! If you get stuck, remember to
        <a href="https://docs.astro.build/">read the docs</a>
        or <a href="https://astro.build/chat">join us on Discord</a> to ask questions.
      </p>
      <p>
        Looking for a blog template with a bit more personality? Check out
        <a href="https://github.com/Charca/astro-blog-template">astro-blog-template</a>
        by <a href="https://twitter.com/Charca">Maxi Ferreira</a>.
      </p>
    </main>
    <Footer />
  </body>
</html>
